{% extends "base.html" %}
{% block content %}

<div class="max-w-md mx-auto mt-8 p-6 rounded-2xl shadow-xl bg-white space-y-6 text-center border-t-8 {% if rank == 1 %}border-yellow-400{% elif is_last %}border-red-400{% else %}border-indigo-300{% endif %}">

    <!-- Welcome -->
    <h2 class="text-3xl font-extrabold {% if is_last %}text-red-600{% elif rank == 1 %}text-yellow-600{% else %}text-indigo-700{% endif %}">
      ğŸ‘‹ Hi, {{ name }}!
    </h2>
  
    <!-- Round -->
    <div class="text-lg text-gray-500 tracking-wider uppercase font-semibold">
      ğŸ¯ Round {{ round_number }}
    </div>
  
    <!-- Score + Rank -->
    <div class="flex justify-around text-left text-lg mt-4">
      <div class="bg-green-100 text-green-800 px-4 py-2 rounded-xl w-[45%] shadow-sm">
        <div class="text-xs uppercase font-bold text-green-700">Game Score</div>
        <div class="text-2xl font-bold">{{ score }}</div>
      </div>
      <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-xl w-[45%] shadow-sm">
        <div class="text-xs uppercase font-bold text-blue-700">Rank</div>
        <div class="text-2xl font-bold">{{ rank }} <span class="text-sm text-gray-600">of {{ total_players }}</span></div>
      </div>
    </div>
  
    <!-- Bid Summary -->
    {% if last_bid is not none %}
    <div class="bg-gray-100 px-4 py-3 rounded-lg text-gray-700 shadow-sm">
      <span class="font-semibold">Current Round âœ</span>
      <span class="ml-2">ğŸ¯ <strong>Bid:</strong> {{ last_bid }} | <strong>Won:</strong> {{ last_won }}</span>
    </div>
    {% endif %}
  
    <!-- Suggested Bid -->
    <div class="bg-yellow-100 text-yellow-800 px-6 py-3 rounded-full text-lg font-semibold shadow-inner">
      ğŸ’¡ Suggested Bid: {{ suggested_bid }}
    </div>
  
    {% if hint %}
    <div class="text-red-500 font-medium text-sm mt-1">
      âš ï¸ {{ hint }}
    </div>
    {% endif %}
  
    {% if is_last %}
    <div class="text-xs text-red-500 font-semibold italic animate-pulse">
      Youâ€™re trailing. Time for a comeback move! ğŸ”¥
    </div>
    {% endif %}
  
    <p class="text-xs text-gray-400 italic mt-4">Stay sharp. Every round counts!</p>
    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-gray-200 rounded-lg text-sm hover:bg-gray-300">
        ğŸ”„ Refresh Page
    </button>
  </div>  

  <script>
    const socket = new WebSocket(`ws://${window.location.host}/socket/scores`);
    let hasReloaded = false;
    const RELOAD_THROTTLE_MS = 3000;
    
    socket.onmessage = (event) => {
        if (event.data === "update" && !hasReloaded) {
            hasReloaded = true;
            console.log("ğŸ”„ Reloading due to socket update...");
            setTimeout(() => location.reload(), 300);  // Small delay to allow any layout to settle
        }
    };
    </script>
  
  <script>
    let lastRound = {{ round_number }};  // from Jinja context
    const playerId = {{ id }};  // inject player id in the page context
    const POLL_INTERVAL = 5000; // 5 seconds
    
    async function checkForUpdate() {
        try {
            const res = await fetch(`/player/${playerId}/checkin`);
            const data = await res.json();
            if (data.round_number > lastRound) {
                console.log("ğŸ•’ Round has advanced. Reloading...");
                location.reload();
            }
        } catch (e) {
            console.warn("Polling failed", e);
        }
    }
    
    // Poll periodically
    setInterval(checkForUpdate, POLL_INTERVAL);
    </script>

{% endblock %}
